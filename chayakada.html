<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chayakkada Vaarthamanangal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Correctly loading Firebase v9 modular CDN scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    window.initializeApp = initializeApp;
    window.getAuth = getAuth;
    window.signInWithCustomToken = signInWithCustomToken;
    window.signInAnonymously = signInAnonymously;
    window.onAuthStateChanged = onAuthStateChanged;
    window.getFirestore = getFirestore;
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Noto+Sans+Malayalam:wght@400;600;700&family=Amatic+SC:wght@700&display=swap');
    body {
      font-family: 'Noto Sans Malayalam', 'Inter', sans-serif;
      transition: background-color 0.5s ease, color 0.5s ease;
    }
    .title-font {
      font-family: 'Amatic SC', cursive;
    }
    .chayakkada-bg {
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    .chayakkada-bg.dark-theme {
      background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1596791244498-8c1d556c4d7d?q=80&w=2070&auto=format&fit=crop');
    }
    .chayakkada-bg.light-theme {
      background-image: linear-gradient(rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.3)), url('https://images.unsplash.com/photo-1565551984242-7c85854b73b2?q=80&w=2070&auto=format&fit=crop');
    }
    @keyframes steam-float {
      0% {
        transform: translateY(0) scale(0.5);
        opacity: 0;
      }
      50% {
        opacity: 0.8;
      }
      100% {
        transform: translateY(-50px) scale(1.2);
        opacity: 0;
      }
    }
    .steam-puff {
      position: absolute;
      bottom: 15px;
      left: 50%;
      width: 30px;
      height: 30px;
      background-color: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      transform: translateX(-50%);
      animation: steam-float 5s infinite;
    }
    .steam-puff.delay-1 {
      animation-delay: 1.5s;
      width: 40px;
      height: 40px;
    }
    .steam-puff.delay-2 {
      animation-delay: 3s;
      width: 35px;
      height: 35px;
    }
    .glass-container {
      -webkit-backdrop-filter: blur(15px);
      backdrop-filter: blur(15px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
      border-radius: 2rem;
    }
    .glass-container.dark-theme {
      background-color: rgba(30, 41, 59, 0.75);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .glass-container.light-theme {
      background-color: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    .text-input {
      border: 1px solid rgba(255, 255, 255, 0.15);
      padding: 1rem;
      border-radius: 0.75rem;
      outline: none;
      transition: all 0.2s;
    }
    .text-input.dark-theme {
      background-color: rgba(51, 65, 85, 0.8);
      color: #cbd5e1;
    }
    .text-input.light-theme {
      background-color: rgba(255, 255, 255, 0.8);
      color: #1e293b;
      border-color: rgba(0, 0, 0, 0.2);
    }
    .text-input.dark-theme::placeholder {
      color: #94a3b8;
    }
    .text-input.light-theme::placeholder {
      color: #64748b;
    }
    .text-input.dark-theme:focus {
      background-color: rgba(51, 65, 85, 0.9);
      border-color: #fcd34d;
      box-shadow: 0 0 0 2px #fcd34d;
    }
    .text-input.light-theme:focus {
      background-color: rgba(255, 255, 255, 0.9);
      border-color: #fcd34d;
      box-shadow: 0 0 0 2px #fcd34d;
    }
    .conversation-output {
      border-radius: 0.75rem;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    .conversation-output.dark-theme {
      background-color: rgba(51, 65, 85, 0.8);
      color: #f8fafc;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    .conversation-output.light-theme {
      background-color: rgba(255, 255, 255, 0.8);
      color: #1e293b;
      border: 1px solid rgba(0, 0, 0, 0.15);
    }
  </style>
</head>
<body class="bg-slate-900">

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // The Firebase functions are now globally available after the modular import
    // so we can access them directly.
    
    // Define placeholder for Firebase config and token. These will be provided by the runtime.
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Function to handle exponential backoff for API retries
    async function fetchWithRetry(url, options, retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, options);
          if (response.ok) {
            return response;
          }
          throw new Error(`API returned non-OK status: ${response.status}`);
        } catch (error) {
          if (i < retries - 1) {
            const delay = Math.pow(2, i) * 1000; // Exponential backoff: 1s, 2s, 4s
            await new Promise(resolve => setTimeout(resolve, delay));
          } else {
            throw error;
          }
        }
      }
    }

    // Main App component
    const App = () => {
      const [topic, setTopic] = useState('');
      const [conversation, setConversation] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [isAuthReady, setIsAuthReady] = useState(false);
      const [db, setDb] = useState(null);
      const [auth, setAuth] = useState(null);
      const [userId, setUserId] = useState(null);
      const [theme, setTheme] = useState(() => {
        // Initialize theme from localStorage or default to 'dark'
        return localStorage.getItem('theme') || 'dark';
      });

      useEffect(() => {
        // Initialize Firebase
        if (Object.keys(firebaseConfig).length) {
          const app = window.initializeApp(firebaseConfig);
          const authInstance = window.getAuth(app);
          const dbInstance = window.getFirestore(app);
          setAuth(authInstance);
          setDb(dbInstance);

          // Listen for auth state changes
          const unsubscribe = window.onAuthStateChanged(authInstance, (user) => {
            if (user) {
              setUserId(user.uid);
            } else {
              // If no user, sign in anonymously or with custom token
              (async () => {
                try {
                  if (initialAuthToken) {
                    await window.signInWithCustomToken(authInstance, initialAuthToken);
                  } else {
                    await window.signInAnonymously(authInstance);
                  }
                } catch (authError) {
                  console.error("Firebase Auth failed:", authError);
                } finally {
                  setIsAuthReady(true);
                }
              })();
            }
          });
          return () => unsubscribe();
        } else {
          setIsAuthReady(true);
        }
      }, []);

      useEffect(() => {
        // Apply the theme class to the body element and save to localStorage
        document.body.className = `${theme === 'dark' ? 'bg-slate-900' : 'bg-white'} ${theme}-theme`;
        localStorage.setItem('theme', theme);
      }, [theme]);

      const handleGenerate = async (e) => {
        e.preventDefault();
        setLoading(true);
        setConversation(null);
        setError(null);
        
        // This is where you should add your API key. Replace the empty string with your key.
        const apiKey = "AIzaSyDG8akJd_nm29uPgTxzRq74wvgHyYH5PU8"; // Your API key goes here
        if (!apiKey) {
            setError('API key is missing. Please ensure it is correctly configured.');
            setLoading(false);
            return;
        }

        const prompt = `
          Create a funny, casual conversation in a tea shop (ചായക്കട) in Kerala, between four fictional characters, in the Malayalam language.
          The characters are:
          1.  **കുട്ടൻ:** A humorous person with strong opinions.
          2.  **ചന്ദ്രൻ ചേട്ടൻ:** An older man who knows everything about local news and politics.
          3.  **ബിജു:** A younger man who is interested in modern technology and movies.
          4.  **ചായക്കടക്കാരൻ:** The tea shop owner who serves tea and occasionally makes small, witty comments.
          
          The conversation should be about the following topic: "${topic}".
          Please format the response in a conversational style, with each character's name in bold before their dialogue. The language used should be authentic and natural.
        `;

        try {
          const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }] }],
          };
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

          const response = await fetchWithRetry(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          const result = await response.json();
          if (result.candidates && result.candidates.length > 0 &&
              result.candidates[0].content && result.candidates[0].content.parts &&
              result.candidates[0].content.parts.length > 0) {
            const text = result.candidates[0].content.parts[0].text;
            setConversation(text);
          } else {
            setError('Something went wrong. Please try again.');
          }
        } catch (err) {
          console.error('API Error:', err);
          setError('An error occurred while generating the conversation. Please check your internet connection or try again later.');
          } finally {
            setLoading(false);
          }
        };

        const toggleTheme = () => {
          setTheme(prevTheme => prevTheme === 'dark' ? 'light' : 'dark');
        };

        const themeButtonText = theme === 'dark' ? 'Light Theme' : 'Dark Theme';
        const isDark = theme === 'dark';

        return (
          <div className={`chayakkada-bg flex min-h-screen items-center justify-center p-4 font-sans antialiased relative overflow-hidden ${theme}-theme`}>
              <div className="absolute top-4 right-4 z-20">
                <button
                  onClick={toggleTheme}
                  className="px-4 py-2 rounded-full text-sm font-semibold transition-colors duration-300
                            text-white bg-gray-800 hover:bg-gray-700
                            dark:text-gray-800 dark:bg-white dark:hover:bg-gray-200"
                >
                  {themeButtonText}
                </button>
              </div>
              <div className={`w-full max-w-3xl glass-container rounded-3xl p-8 shadow-2xl transition-all duration-300 hover:shadow-2xl border-2 relative z-10 ${theme}-theme`}>
                
                <div className="flex flex-col items-center text-center relative">
                    <div className="relative inline-block mb-2">
                        <svg className={`w-16 h-16 relative z-10 ${isDark ? 'text-yellow-300' : 'text-orange-500'}`} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.477 2 2 6.477 2 12c0 1.942.544 3.754 1.488 5.31l-1.07 1.07a1 1 0 000 1.414l1.414 1.414a1 1 0 001.414 0l1.07-1.07C7.246 21.456 9.058 22 11 22h1c5.523 0 10-4.477 10-10S17.523 2 12 2zm6 10h-2a1 1 0 01-1-1v-1a1 1 0 011-1h2a1 1 0 011 1v1a1 1 0 01-1 1zm-4 0h-2a1 1 0 01-1-1v-1a1 1 0 011-1h2a1 1 0 011 1v1a1 1 0 01-1 1zm-4 0H8a1 1 0 01-1-1v-1a1 1 0 011-1h2a1 1 0 011 1v1a1 1 0 01-1 1z"/>
                        </svg>
                        <div className="steam-container absolute -top-8 left-1/2 -translate-x-1/2">
                            <div className="steam-puff"></div>
                            <div className="steam-puff delay-1"></div>
                            <div className="steam-puff delay-2"></div>
                        </div>
                    </div>
                    <h1 className={`text-4xl font-extrabold mb-2 title-font drop-shadow-lg ${isDark ? 'text-yellow-300' : 'text-orange-700'}`}>ചായക്കടയിലെ വർത്തമാനങ്ങൾ</h1>
                    <p className={`text-lg mb-6 max-w-md drop-shadow-md ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>
                        ഒരു വിഷയം നൽകുക, ചായക്കടയിലെ കൂട്ടുകാർ അതിനെക്കുറിച്ച് സംസാരിക്കുന്നത് കാണാം.
                    </p>
                </div>

                <form onSubmit={handleGenerate} className="flex flex-col space-y-4">
                    <textarea
                        className={`text-input ${theme}-theme`}
                        rows="3"
                        placeholder="സംസാരിക്കാനുള്ള വിഷയം ഇവിടെ ടൈപ്പ് ചെയ്യുക... ഉദാഹരണത്തിന്, 'പുതിയ സിനിമ', 'നാട്ടിലെ മഴ'"
                        value={topic}
                        onChange={(e) => setTopic(e.target.value)}
                        disabled={loading}
                    ></textarea>
                    <button
                        type="submit"
                        className={`w-full px-6 py-3 font-bold text-lg rounded-xl shadow-lg transition-transform transform hover:scale-105 active:scale-95 disabled:shadow-none
                        ${isDark ? 'bg-yellow-600 text-white disabled:bg-slate-700 disabled:text-slate-400' : 'bg-orange-600 text-white disabled:bg-gray-300 disabled:text-gray-500'}`}
                        disabled={!topic || loading}
                    >
                        {loading ? 'സംഭാഷണം ഉണ്ടാക്കുന്നു...' : 'സംഭാഷണം ഉണ്ടാക്കുക'}
                    </button>
                </form>

                {loading && (
                    <div className="flex items-center justify-center mt-8">
                        <svg className={`animate-spin h-8 w-8 ${isDark ? 'text-yellow-600' : 'text-orange-600'}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span className={`ml-4 ${isDark ? 'text-yellow-600' : 'text-orange-600'}`}>AI ചിന്തിക്കുന്നു...</span>
                    </div>
                )}

                {error && (
                    <div className={`mt-8 p-4 rounded-xl ${isDark ? 'bg-red-800 border border-red-600 text-red-300' : 'bg-red-100 border border-red-400 text-red-700'}`} role="alert">
                        <p className="font-bold">Error:</p>
                        <p>{error}</p>
                    </div>
                )}

                {conversation && (
                    <div className={`mt-8 p-6 conversation-output animate-fade-in-up ${theme}-theme`}>
                        <h2 className={`text-2xl font-bold mb-4 ${isDark ? 'text-yellow-600' : 'text-orange-600'}`}>ഇന്നത്തെ വർത്തമാനം:</h2>
                        <div
                            className={`leading-relaxed ${isDark ? 'text-slate-300' : 'text-gray-800'}`}
                            dangerouslySetInnerHTML={{
                                __html: conversation.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br />')
                            }}
                        />
                    </div>
                )}
            </div>
          </div>
        );
      };

      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
</body>
</html>
